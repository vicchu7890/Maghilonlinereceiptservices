<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maghil Online Services - Receipt Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <style>
        /* ... (keep all your existing CSS styles exactly as they are) ... */

        /* Print Styles - COMPLETELY FIXED */
        @media print {
            @page {
                margin: 0.5cm;
                size: auto;
            }
            
            body, html {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                color: black !important;
                font-size: 12pt;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            body * {
                visibility: hidden;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                background: transparent !important;
            }
            
            #printable-receipt,
            #printable-receipt * {
                visibility: visible !important;
            }
            
            #printable-receipt {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 15px !important;
                background: white !important;
                color: black !important;
                border: none !important;
                box-shadow: none !important;
                font-family: 'Courier New', monospace !important;
                font-size: 12pt !important;
                line-height: 1.2 !important;
            }
            
            .no-print, #three-container, .floating-shapes, .form-container, 
            .preview-container, .online-services, footer, 
            header, .container > *:not(#printable-receipt), 
            .btn, h2, .service-card {
                display: none !important;
            }
            
            .receipt-header {
                border-bottom: 2px solid #000 !important;
                text-align: center !important;
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
            }
            
            .receipt-table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin: 10px 0 !important;
            }
            
            .receipt-table th, .receipt-table td {
                border-bottom: 1px solid #000 !important;
                padding: 5px !important;
                text-align: left !important;
            }
            
            .receipt-totals {
                border-top: 2px solid #000 !important;
                padding-top: 10px !important;
                margin-top: 10px !important;
            }
            
            .receipt-footer {
                border-top: 2px solid #000 !important;
                text-align: center !important;
                margin-top: 15px !important;
                padding-top: 10px !important;
                font-style: italic !important;
            }
            
            /* Hide the original receipt preview */
            #receiptOutput {
                display: none !important;
            }
        }

        /* Hidden printable receipt */
        #printable-receipt {
            display: none;
        }
    </style>
</head>
<body>
    <div id="three-container"></div>
    
    <div class="floating-shapes">
        <div class="shape" style="width: 80px; height: 80px; top: 10%; left: 5%; animation-delay: 0s;"></div>
        <div class="shape" style="width: 120px; height: 120px; top: 20%; left: 80%; animation-delay: 2s;"></div>
        <div class="shape" style="width: 60px; height: 60px; top: 60%; left: 10%; animation-delay: 4s;"></div>
        <div class="shape" style="width: 100px; height: 100px; top: 70%; left: 70%; animation-delay: 6s;"></div>
        <div class="shape" style="width: 90px; height: 90px; top: 30%; left: 40%; animation-delay: 8s;"></div>
    </div>

    <div class="container">
        <header class="no-print">
            <!-- ... (keep your existing header content) ... -->
        </header>

        <div class="main-content no-print">
            <div class="form-container fade-in">
                <!-- ... (keep your existing form content) ... -->
            </div>
            
            <div class="preview-container fade-in">
                <h2><i class="fas fa-eye"></i> Receipt Preview</h2>
                <div class="receipt" id="receiptOutput">
                    <!-- ... (keep your existing receipt preview content) ... -->
                </div>
            </div>
        </div>

        <!-- HIDDEN PRINTABLE RECEIPT -->
        <div id="printable-receipt">
            <div class="receipt-header">
                <div style="font-size: 16pt; font-weight: bold; margin-bottom: 8px;">MAGHIL ONLINE SERVICES</div>
                <div style="font-size: 12pt; font-weight: bold; margin-bottom: 5px;">RTO & Documentation Center</div>
                <div>Sirupooluvappatti, 15 Velampalayam</div>
                <div>Tiruppur RTO North Opposite</div>
                <div>Tiruppur - 641603 | Contact : info@maghilonlineservices.org</div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <div><strong>Memo No:</strong> MAG-<span id="print-memoNumber">001</span></div>
                <div><strong>Date:</strong> <span id="print-currentDate"></span></div>
                <div><strong>Customer:</strong> <span id="print-customerName">[Customer Name]</span></div>
                <div><strong>Contact:</strong> <span id="print-customerContact">[Customer Contact]</span></div>
            </div>
            
            <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                <thead>
                    <tr>
                        <th style="border-bottom: 1px solid #000; padding: 5px; text-align: left;">Service/Item</th>
                        <th style="border-bottom: 1px solid #000; padding: 5px; text-align: left;">Qty</th>
                        <th style="border-bottom: 1px solid #000; padding: 5px; text-align: left;">Price</th>
                        <th style="border-bottom: 1px solid #000; padding: 5px; text-align: left;">Total</th>
                    </tr>
                </thead>
                <tbody id="print-receiptItems">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 5px;">No items added yet</td>
                    </tr>
                </tbody>
            </table>
            
            <div style="border-top: 2px solid #000; padding-top: 10px; margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span><strong>Grand Total:</strong></span>
                    <span><strong id="print-grandTotal">₹0.00</strong></span>
                </div>
            </div>
            
            <div style="margin: 10px 0;">
                <div><strong>Payment Method:</strong> <span id="print-paymentMethod">[Payment Method]</span></div>
            </div>
            
            <div class="receipt-footer">
                <div>Thank you for your business!</div>
                <div>Keep In Touch!</div>
            </div>
        </div>

        <div class="online-services no-print">
            <!-- ... (keep your existing services content) ... -->
        </div>

        <footer class="no-print">
            <!-- ... (keep your existing footer content) ... -->
        </footer>
    </div>

    <script>
        // Set current date for both preview and print
        const currentDate = new Date().toLocaleDateString();
        document.getElementById('currentDate').textContent = currentDate;
        document.getElementById('print-currentDate').textContent = currentDate;
        
        // Memo number counter
        let memoCounter = 1;

        // ... (keep all your existing JavaScript functions exactly as they are) ...

        // Generate receipt - UPDATED to update both preview and print versions
        function generateReceipt() {
            const customerName = document.getElementById('customerName').value || 'Walk-in Customer';
            const customerContact = document.getElementById('customerContact').value || 'N/A';
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            // Update memo number for both preview and print
            const memoNumber = memoCounter.toString().padStart(3, '0');
            document.getElementById('memoNumber').textContent = memoNumber;
            document.getElementById('print-memoNumber').textContent = memoNumber;
            memoCounter++;
            
            // Update receipt header for both preview and print
            document.getElementById('printCustomerName').textContent = customerName;
            document.getElementById('print-customerName').textContent = customerName;
            
            document.getElementById('printCustomerContact').textContent = customerContact;
            document.getElementById('print-customerContact').textContent = customerContact;
            
            document.getElementById('printPaymentMethod').textContent = paymentMethod;
            document.getElementById('print-paymentMethod').textContent = paymentMethod;
            
            // Calculate items and totals for both preview and print
            let subtotal = 0;
            let itemsHTML = '';
            let printItemsHTML = '';
            
            document.querySelectorAll('.item-row').forEach(row => {
                const name = row.querySelector('.item-name').value;
                const qty = parseInt(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = qty * price;
                subtotal += total;
                
                if(name && qty > 0 && price > 0) {
                    itemsHTML += `
                        <tr>
                            <td>${name}</td>
                            <td>${qty}</td>
                            <td>₹${price.toFixed(2)}</td>
                            <td>₹${total.toFixed(2)}</td>
                        </tr>
                    `;
                    
                    printItemsHTML += `
                        <tr>
                            <td style="padding: 3px;">${name}</td>
                            <td style="padding: 3px;">${qty}</td>
                            <td style="padding: 3px;">₹${price.toFixed(2)}</td>
                            <td style="padding: 3px;">₹${total.toFixed(2)}</td>
                        </tr>
                    `;
                }
            });
            
            // If no valid items, show placeholder for both
            if (itemsHTML === '') {
                itemsHTML = '<tr><td colspan="4" style="text-align: center;">No valid items added</td></tr>';
                printItemsHTML = '<tr><td colspan="4" style="text-align: center; padding: 5px;">No valid items added</td></tr>';
            }
            
            document.getElementById('receiptItems').innerHTML = itemsHTML;
            document.getElementById('print-receiptItems').innerHTML = printItemsHTML;
            
            const grandTotal = subtotal;
            
            // Update totals for both
            const grandTotalText = `₹${grandTotal.toFixed(2)}`;
            document.getElementById('printGrandTotal').textContent = grandTotalText;
            document.getElementById('print-grandTotal').textContent = grandTotalText;
            
            // Add animation to receipt preview only
            const receipt = document.getElementById('receiptOutput');
            receipt.classList.remove('pulse');
            void receipt.offsetWidth;
            receipt.classList.add('pulse');
            
            // Add 3D effect to receipt preview only
            receipt.style.transform = 'perspective(1000px) rotateX(5deg)';
            setTimeout(() => {
                receipt.style.transform = 'perspective(1000px) rotateX(0deg)';
            }, 500);
        }

        // Print receipt - COMPLETELY FIXED
        function printReceipt() {
            // First generate the receipt to ensure all data is updated
            generateReceipt();
            
            // Show the printable receipt
            document.getElementById('printable-receipt').style.display = 'block';
            
            // Wait a moment for the DOM to update, then print
            setTimeout(() => {
                window.print();
                
                // Hide the printable receipt after printing
                setTimeout(() => {
                    document.getElementById('printable-receipt').style.display = 'none';
                }, 100);
            }, 100);
        }

        // ... (keep all your other JavaScript functions exactly as they are) ...

        // Initialize with one item row
        window.onload = function() {
            addItem();
            generateReceipt();
            
            // Add some sample data for demo
            setTimeout(() => {
                document.getElementById('customerName').value = 'Rajesh Kumar';
                document.getElementById('customerContact').value = '9876543210';
                document.querySelector('.item-name').value = 'DL Renewal Service';
                document.querySelector('.item-price').value = '500';
                generateReceipt();
            }, 1000);
        };
    </script>
</body>
</html>
